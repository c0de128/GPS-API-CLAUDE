<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS API Access Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #location-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .coordinate {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }
        .speed {
            font-size: 16px;
            color: #007bff;
        }
        .timestamp {
            color: #6c757d;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ∞Ô∏è GPS Vehicle Tracking API Test</h1>

        <div class="status info">
            <strong>Instructions:</strong>
            <ol>
                <li>Make sure your GPS app is running at <code>http://localhost:3000</code></li>
                <li>Verify the API server is running at <code>http://localhost:3003</code></li>
                <li>Click the buttons below to test GPS data access</li>
            </ol>
        </div>

        <div>
            <button onclick="getCurrentLocation()">üéØ Get Current Location</button>
            <button onclick="getLocationHistory()">üìã Get Location History (Last 5)</button>
            <button onclick="startPolling()" id="poll-btn">‚ñ∂Ô∏è Start Auto-Polling (2s)</button>
            <button onclick="stopPolling()" id="stop-btn" disabled>‚èπÔ∏è Stop Auto-Polling</button>
        </div>

        <div id="status"></div>
        <div id="location-data"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3003/api/v1';
        const API_KEY = 'gps_dev_1452bec4359a449aa8b35c97adcbb900';
        let pollingInterval = null;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function displayLocationData(data, title = 'Location Data') {
            const dataDiv = document.getElementById('location-data');

            if (!data.success) {
                dataDiv.innerHTML = `<h3>‚ùå ${title}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                return;
            }

            const location = data.data;
            if (Array.isArray(location.locations)) {
                // Location history
                dataDiv.innerHTML = `
                    <h3>üìã ${title} (${location.total} total)</h3>
                    ${location.locations.map((loc, i) => `
                        <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                            <div class="coordinate">üìç ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}</div>
                            <div class="speed">üöó Speed: ${(loc.speed * 2.237).toFixed(1)} mph (${loc.speed.toFixed(2)} m/s)</div>
                            <div class="timestamp">üïê ${new Date(loc.timestamp).toLocaleString()}</div>
                            <div>üéØ Accuracy: ¬±${loc.accuracy.toFixed(1)}m</div>
                        </div>
                    `).join('')}
                `;
            } else {
                // Single location
                dataDiv.innerHTML = `
                    <h3>üéØ ${title}</h3>
                    <div class="coordinate">üìç Coordinates: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}</div>
                    <div class="speed">üöó Speed: ${(location.speed * 2.237).toFixed(1)} mph (${location.speed.toFixed(2)} m/s)</div>
                    <div class="timestamp">üïê Timestamp: ${new Date(location.timestamp).toLocaleString()}</div>
                    <div>üéØ Accuracy: ¬±${location.accuracy.toFixed(1)}m</div>
                    ${location.altitude ? `<div>‚õ∞Ô∏è Altitude: ${location.altitude.toFixed(1)}m</div>` : ''}
                    ${location.heading !== undefined ? `<div>üß≠ Heading: ${location.heading.toFixed(0)}¬∞</div>` : ''}
                `;
            }
        }

        async function apiRequest(endpoint) {
            try {
                showStatus(`üîÑ Requesting: ${endpoint}`, 'info');

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(`‚úÖ API request successful`, 'success');
                } else {
                    showStatus(`‚ùå API error: ${data.error}`, 'error');
                }

                return data;
            } catch (error) {
                showStatus(`üí• Request failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function getCurrentLocation() {
            const data = await apiRequest('/gps/location');
            displayLocationData(data, 'Current Vehicle Location');
        }

        async function getLocationHistory() {
            const data = await apiRequest('/gps/location/history?limit=5');
            displayLocationData(data, 'Location History');
        }

        function startPolling() {
            if (pollingInterval) return;

            document.getElementById('poll-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;

            showStatus('üîÑ Auto-polling started (every 2 seconds)', 'info');

            pollingInterval = setInterval(async () => {
                const data = await apiRequest('/gps/location');
                if (data.success) {
                    const location = data.data;
                    const timestamp = new Date().toLocaleTimeString();
                    displayLocationData(data, `Live Tracking (${timestamp})`);
                }
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            document.getElementById('poll-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;

            showStatus('‚èπÔ∏è Auto-polling stopped', 'info');
        }

        // Test API connection on page load
        window.onload = async () => {
            showStatus('üîç Testing API connection...', 'info');

            try {
                const response = await fetch(`${API_BASE.replace('/api/v1', '')}/health`);
                const health = await response.json();

                if (health.status === 'healthy') {
                    showStatus('‚úÖ API server is connected and healthy!', 'success');
                } else {
                    showStatus('‚ö†Ô∏è API server responded but may have issues', 'error');
                }
            } catch (error) {
                showStatus('‚ùå Cannot connect to API server. Make sure it\'s running on port 3003.', 'error');
            }
        };
    </script>
</body>
</html>